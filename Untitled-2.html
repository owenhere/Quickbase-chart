<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://unpkg.com/slim-select@latest/dist/slimselect.min.js"></script>
    <link href="https://unpkg.com/slim-select@latest/dist/slimselect.css" rel="stylesheet"></link>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.webix.com/edge/webix.min.css" type="text/css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.min.css"> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        /* Custom styles for the autocomplete suggestions */
        .aa-suggestions {
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .aa-suggestion {
            padding: 10px;
            cursor: pointer;
        }
        .aa-dropdown-menu {
          margin-left: 20px;
        }
        .aa-suggestion:hover,
        .aa-suggestion.aa-cursor {
            background-color: #f0f0f0;
        }
        
        .aa-suggestion div {
            font-size: 14px;
        }
        .webix_layout_line .webix_sidebar {
            right: 0;
            left: auto;
            overflow-y: auto;
        }
        #sidebar {
          position: absolute;
          right: 0;
        }
        .delete-icon {
            cursor: pointer;
            margin-left: 10px;
            color: rgb(117, 110, 110);
        }
        .webix_tree_item {
          display: flex;
          justify-content: space-between;
        }
        .loading {
            display: none;
            font-size: 20px;
            align-items: center;
            justify-content: center;
            color: blue;
        }
        .result {
            display: none;
        }
    </style>
    <style>
      .google-visualization-controls-label{
        padding-bottom: 8px;
      }
    </style>
  </head>
  <body class="flex flex-row ">
    <div id="combo_chart_div" style="width: 80vw;">
      <div class="flex flex-col">
        <div class="flex flex-row items-center">
          <select id="laboratory" multiple class="w-[300px] m-4" >
          </select>
          <select id="department" multiple class="w-[300px] m-4">
          </select>
          <select id="employees" multiple class="w-[300px] m-4">
          </select>
          <select id="calendartype" multiple class="w-[300px] m-4">
          </select>
        </div>
        <div class="flex flex-row items-center">
          <input type="text" id="employeeInput" placeholder="Employee" class="w-[150px], border h-[30px] rounded m-4">
          <div class="ml-2">Is on or After:</div>
          <input type="text" id="fromInput" class="w-[50px] border h-[30px] rounded m-4">
          <select id="fromSel" class="w-[200px] m-4">
            <option value="0">the date</option>
            <option value="1">day(s) in the past</option>
            <option value="2">yesterday</option>
            <option value="3" selected>today</option>
            <option value="4">tomorrow</option>
            <option value="5">day(s) in the future</option>
          </select>
          <input id="frompicker" class="w-[150px] border h-[30px] rounded m-4" type="text"/>
          <!-- <input type="text" id="fromInput" placeholder="From Year-Week(****.**)" class="w-[150px], border h-[30px] rounded m-4"> -->
          <div class="ml-2">Is on or Before:</div>
          <input type="text" id="toInput" class="w-[50px] border h-[30px] rounded m-4">
          <select id="toSel" class="w-[200px] m-4">
            <option value="0">the date</option>
            <option value="1">day(s) in the past</option>
            <option value="2">yesterday</option>
            <option value="3">today</option>
            <option value="4">tomorrow</option>
            <option value="5" selected>day(s) in the future</option>
          </select>
          <input id="topicker" class="w-[150px] border h-[30px] rounded m-4" />
          <!-- <input type="text" id="toInput" placeholder="To Year-Week(****.**)" class="w-[150px], border h-[30px] rounded m-4"> -->
          
        </div>
        <div class="flex flex-row items-center ml-[20px]">
          <label>Stacked</label>
          <select id="stackedBar" class="w-[150px] m-4">
            <option value="0">None</option>
            <option value="1">Service Type</option>
            <option value="2">Assay Type</option>
          </select>
          <input type="checkbox" class="mx-2" id="sameaxis" checked/> 
          <label for="sameaxis">Use Same Axis</label>
          <div class="flex flex-row items-center ml-[20px]" id="saveDIV">
            <input type="text" id="name" class="w-[200px] h-[30px] border rounded m-4" placeholder="Enter the name for saving.">
            <button onclick="saveFilters()">Save</button>
          </div>
        </div>
        
      </div>
      <div id="loading" style="width: 90vw; height: 80vh;" class="loading">Loading...</div>
      <div id="chart_div" style="width: 90vw; height: 80vh;" class="flex items-center justify-center"></div>
    </div>
    <div id="sidebar"></div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.webix.com/edge/webix.min.js" type="text/javascript"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.min.js"></script> -->
    <script type="text/javascript">
      let calendar_resource_Data, displayData, laboratoryFilters = [], employeeFilter = [], departmentFilters = [], serviceTypes = [], assayTypes = [];
      let netherlands_E_Filters = [], lenexa_E_Filters = [], whitesboro_E_Filters = [], calendarTypeFilters = [], stackedType = 0, same = true;
      let laboSelFilter = [], deparSelFilter = [], emploSelFilter = "", employeeSelFilter = [], calendarSelFilter = [], fromFilters = 0, toFilters = 0 ;
      let loadingElement, resultElement, tempEmployee = [], flag = 0, isAvailable = true;
      let fromType=3, toType=5, fromInputVal = 0, toInputVal = 365;
      let availableEmails = ['m.berroth@outlook.com','tebebegaredew@gmail.com', 'nmallet@quickbase.com', 'racevedo@quickbase.com', 'James.Everett@iconplc.com','Joury.Kloostervant@iconplc.com', 'Niki.Keith@iconplc.com', 'Srinivas.Ramasubramanian@iconplc.com'];

      const currentDate = new Date();
      let oneYearLater = new Date(currentDate)
      oneYearLater.setDate(currentDate.getDate() + 365)
      let from = parseFloat(getYearWeek(currentDate));
      let to = parseFloat(getYearWeek(oneYearLater));
      // ----------- get email -----------------
      let isEmail = 0, email;
      for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i); // Get the key
        let value = localStorage.getItem(key); // Get the value

        // Convert value to string if it's not null or undefined
        if (value !== null && value !== undefined) {
          const str = String(value); // Convert and set back to localStorage
          if(str.includes('signedInAs')) {
            const data = JSON.parse(str);
            const temp = Object.keys(data);
            for(let i = 0; i < temp.length; i++){
              if(temp[i].includes('ReportMetadataPayload')) {
                email = data[temp[i]].signedInAs
                isEmail = 1;
                break;
              }
            }
          }
        }
        if(isEmail === 1) break;
      }

      if(!email || !availableEmails.includes(email)) {
        isAvailable = false;
        document.getElementById('saveDIV').style.display = 'none';
      }
      
      let sidebarData = [];
      $('#frompicker').datepicker({
        uiLibrary: 'bootstrap'
      });
      $('#topicker').datepicker({
        uiLibrary: 'bootstrap'
      });
      $('#frompicker').on('changeDate', function(event) {
        if(event.date){
          fromFilters = parseFloat(getYearWeek(event.date));
          google.charts.setOnLoadCallback(drawChart);
        }
      });
      $('#topicker').on('changeDate', function(event) {
        if(event.date) {
          toFilters = parseFloat(getYearWeek(event.date));
          google.charts.setOnLoadCallback(drawChart);
        }
      });
      // Initialize Webix layout with sidebar on the right
      webix.ui({
        container: "sidebar",
        rows: [
          {
            cols: [
              {
                view: "sidebar",
                id: "mySidebar",
                data: sidebarData,
                gravity: 1,
                template: function(obj) {
                  if(isAvailable) return obj.value + `<span class='delete-icon' data-id='${obj.id}'>&#10060;</span>`;
                  else return obj.value;
                },
                onClick: {
                  "delete-icon": function(e, id) {        
                    const item = this.getItem(id);
                    deleteItemFromSidebar(id, item.value);
                    return false; // Prevents the default item click event
                  }
                },
                on: {
                  onItemClick: function(id) {
                    // Get the clicked item data
                    const item = this.getItem(id);
                    setFilter(item.filter)
                  }
                }
              }
            ]
          }
        ]
      });


      // Function to delete an item from the sidebar
      function deleteItemFromSidebar(id, name) {
        var headers = {
            'QB-Realm-Hostname': 'icon.quickbase.com',
            'Authorization': `QB-USER-TOKEN b9mjdd_py5p_0_bq3jzc2ceck37fb65tg4ybwegaxm`,
            'Content-Type': 'application/json'
        }
        var body = {
          from: 'bub7gjqmz',
          where: `{13.EX.${name}}`
        }

        fetch('https://api.quickbase.com/v1/records',
          {
            method: 'DELETE',
            headers: headers,
            body: JSON.stringify(body)
          })
        .then(res => {
          if (res.ok) {
            return res.json().then(res => console.log(res));
          }
          return res.json().then(resBody => Promise.reject({status: res.status, ...resBody}));
        })
        .catch(err => console.log(err))
        sidebarData = sidebarData.filter(item => item.id != id);
        $$("mySidebar").clearAll();
        $$("mySidebar").parse(sidebarData);
      }

      let laboratorySelect = new SlimSelect({
        select: '#laboratory',
        settings: {
          placeholderText: 'Laboratory',
        },
        events: {
          afterChange: (newVal) => {
            laboratoryChange();
          }
        }
      })
      let departmentSelect = new SlimSelect({
        select: '#department',
        settings: {
          placeholderText: 'Department',
        },
        events: {
          afterChange: (newVal) => {
            departmentChange();
          }
        }
      })
      let employeeSelect = new SlimSelect({
        select: '#employees',
        settings: {
          placeholderText: 'Employee',
        },
        events: {
          afterChange: (newVal) => {
            employeeChange();
          }
        }
      })
      let calendarSelect = new SlimSelect({
        select: '#calendartype',
        settings: {
          placeholderText: 'Calendar Type',
        },
        events: {
          afterChange: (newVal) => {
            calendarChange();
          }
        }
      })
      let stackedSelect = new SlimSelect({
        select: '#stackedBar',
        settings: {
          placeholderText: 'Show Stacked Bar',
        },
        events: {
          afterChange: (newVal) => {
            stackedChange();
          }
        }
      })

      let fromSelect = new SlimSelect({
        select: '#fromSel',
        settings: {
          placeholderText: 'Show Stacked Bar',
        },
        events: {
          afterChange: (newVal) => {
            fromChange();
          }
        }
      })

      let toSelect = new SlimSelect({
        select: '#toSel',
        settings: {
          placeholderText: 'Show Stacked Bar',
        },
        events: {
          afterChange: (newVal) => {
            toChange();
          }
        }
      })

      fromType = Number(fromSelect.getSelected()[0]);
      toType = Number(toSelect.getSelected()[0]);

      document.getElementById('frompicker').style.display = 'none';
      document.getElementById('topicker').style.display = 'none';
      document.getElementById('fromInput').style.display = 'none';
      document.getElementById('toInput').value = '365';

      async function saveFilters() {

        const url = `https://api.quickbase.com/v1/records`;
        const name = document.getElementById('name').value;
        if(!name) {
          Swal.fire({
            text: 'Please enter the name for saving.',
            icon: 'warning', // 'success', 'error', 'warning', 'info', or 'question'
            timer: 4000, // Auto close in 4 seconds
            showConfirmButton: false, // Hide the "OK" button
            timerProgressBar: true, // Show timer progress bar
            toast: true, // Make it a toast notification
            position: 'top-end', // Position of the notification
            showCloseButton: true // Show close button
          });
          return
        }
        const payload = {
          to: 'bub7gjqmz',
          data: [
            {
              13: {
                "value": name
              },
              6: {
                "value": JSON.stringify(laboSelFilter)
              },
              7: {
                "value": JSON.stringify(deparSelFilter)
              },
              8: {
                "value": JSON.stringify(employeeSelFilter)
              },
              9: {
                "value": JSON.stringify(calendarSelFilter)
              },
              10: {
                "value": emploSelFilter
              },
              11: {
                "value": String(fromFilters)
              },
              12: {
                "value": String(toFilters)
              },
              14: {
                "value": String(stackedType)
              },
              15: {
                "value": String(fromType)
              },
              16: {
                "value": String(fromInputVal)
              },
              17: {
                "value": String(toType)
              },
              18: {
                "value": String(toInputVal)
              },
            }
          ]
        };
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'QB-Realm-Hostname': 'icon.quickbase.com',
            'Authorization': `QB-USER-TOKEN b9mjdd_py5p_0_bq3jzc2ceck37fb65tg4ybwegaxm`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const newItem = { id: webix.uid(), value: name, filter: {
            laboratory: laboSelFilter,
            department: deparSelFilter,
            employees: employeeSelFilter,
            calendarType: calendarSelFilter,
            employee: emploSelFilter,
            stacked: stackedType,
            from: fromFilters,
            to: toFilters,
          } 
        };
        sidebarData.push(newItem);
        $$("mySidebar").clearAll();
        $$("mySidebar").parse(sidebarData);
        const result = await response.json();

        Swal.fire({
          text: 'Save successful.',
          icon: 'success', // 'success', 'error', 'warning', 'info', or 'question'
          timer: 4000, // Auto close in 4 seconds
          showConfirmButton: false, // Hide the "OK" button
          timerProgressBar: true, // Show timer progress bar
          toast: true, // Make it a toast notification
          position: 'top-end', // Position of the notification
          showCloseButton: true // Show close button
        });
      }
      function setFilter (filter) {
        laboSelFilter = filter?.laboratory;
        laboratorySelect.setSelected(laboSelFilter);
        deparSelFilter = filter?.department;
        departmentSelect.setSelected(deparSelFilter);
        employeeSelFilter = filter?.employees;
        flag = 1;
        tempEmployee = employeeSelFilter;
        console.log(tempEmployee)
        // employeeSelect.setSelected(tempEmployee);
        calendarSelFilter = filter?.calendarType;
        calendarSelect.setSelected(calendarSelFilter);
        stackedType = filter?.stacked;
        if(!stackedType) stackedType = 0;
        stackedSelect.setSelected(String(stackedType));
        emploSelFilter = filter?.employee;
        document.getElementById('employeeInput').value = emploSelFilter;
        fromFilters = filter?.from;
        if(fromFilters !== 0) {
          $('#frompicker').datepicker('setDate', getFirstDayOfWeek(fromFilters));
        } else {
          $('#frompicker').datepicker('setDate', currentDate)        
        }
        toFilters = filter?.to;
        if(toFilters !== 0) {
          $('#topicker').datepicker('setDate', getFirstDayOfWeek(toFilters));
        } else {
          $('#topicker').datepicker('setDate', oneYearLater);
        }
        fromInputVal = filter?.fromInputVal;
        document.getElementById('fromInput').value = String(fromInputVal);
        fromType = filter?.fromType;
        fromSelect.setSelected(String(fromType));
        toInputVal = filter?.toInputVal;
        document.getElementById('toInput').value = String(toInputVal);
        toType = filter?.toType;
        toSelect.setSelected(String(toType));
        google.charts.setOnLoadCallback(drawChart);
      }
      function getFirstDayOfWeek(yearWeek) {
        const temp = yearWeek * 100;
        const year = temp / 100;
        const week = temp % 100;
        // const [year, week] = yearWeek.split('.').map(Number);
        
        // Create a new date object for January 1st of the given year
        const firstDayOfYear = new Date(year, 0, 1);
        
        // Get the day of the week for January 1st (0 = Sunday, 1 = Monday, ..., 6 = Saturday)
        const dayOfWeek = firstDayOfYear.getDay();
        
        // Calculate the offset to the first Monday of the year
        const offset = (dayOfWeek <= 4 ? 1 - dayOfWeek : 8 - dayOfWeek);
        
        // Calculate the first day of the given week
        const firstDayOfWeek = new Date(year, 0, 1 + offset + (week - 1) * 7);
        
        return firstDayOfWeek;
      }
      function getYearWeek(date, flag) {
        const target = new Date(date.valueOf());
        const dayNumber = (date.getUTCDay() + 6) % 7; // Get the day number (0-6), with Monday being 0
        target.setUTCDate(target.getUTCDate() - dayNumber + 3); // Set the target date to the Thursday of the current week
        const firstThursday = new Date(target.getUTCFullYear(), 0, 4); // Get the first Thursday of the year
        const diff = target - firstThursday;
        const oneWeek = 1000 * 60 * 60 * 24 * 7;
        const weekNumber = 1 + Math.round(diff / oneWeek); // Calculate the week number

        // Get the year corresponding to the week
        const firstDayOfWeek = new Date(target.setUTCDate(target.getUTCDate() - target.getUTCDay() + 1));
        const year = firstDayOfWeek.getUTCFullYear();
        
        // Format the week number as a two-digit string
        const formattedWeekNumber = weekNumber.toString().padStart(2, '0');
        if(flag === 1) return `${year + 1}.${formattedWeekNumber}`;
        return `${year}.${formattedWeekNumber}`;
      }

      function laboratoryChange() {
        laboSelFilter = laboratorySelect.getSelected();
        console.log(2)
        if(laboSelFilter[0] === 'NETHERLANDS'){
          employeeSelect.setData(netherlands_E_Filters.map(item => {
            return {text: item, value: item}
          }))
        }
        else if(laboSelFilter[0] === 'LENEXA'){
          employeeSelect.setData(lenexa_E_Filters.map(item => {
            return {text: item, value: item}
          }))
        }
        else if(laboSelFilter[0] === 'WHITESBORO'){
          employeeSelect.setData(whitesboro_E_Filters.map(item => {
            return {text: item, value: item}
          }))
        } else {
          employeeSelect.setData(employeeFilter.map(item => {
            return {text: item, value: item}
          }))
        }
        if(flag === 1) {
          employeeSelect.setSelected(tempEmployee);
          flag = 0;
        }
        google.charts.setOnLoadCallback(drawChart);
      }
      function departmentChange() {
        deparSelFilter = departmentSelect.getSelected();
        google.charts.setOnLoadCallback(drawChart);
      }
      function employeeChange() {
        employeeSelFilter = employeeSelect.getSelected();
        google.charts.setOnLoadCallback(drawChart);
      }
      function calendarChange() {
        calendarSelFilter = calendarSelect.getSelected();
        google.charts.setOnLoadCallback(drawChart);
      }
      function stackedChange() {
        stackedType = Number(stackedSelect.getSelected()[0]);
        google.charts.setOnLoadCallback(drawChart);
      }
      function fromChange() {
        fromType = Number(fromSelect.getSelected()[0]);
        if(fromType === 0){
          document.getElementById('frompicker').style.display = 'block';
          document.getElementById('fromInput').style.display = 'none';
          $('#frompicker').datepicker('setDate', currentDate)
          let tempDate = new Date(currentDate);
          fromFilters = parseFloat(getYearWeek(tempDate))
        }
        else if(fromType === 1) {
          document.getElementById('fromInput').style.display = 'block';
          document.getElementById('frompicker').style.display = 'none';
          document.getElementById('fromInput').value = '1';
          fromInputVal = 1;
          let tempDate = new Date(currentDate);
          tempDate.setDate(currentDate.getDate() - 1);
          fromFilters = parseFloat(getYearWeek(tempDate))
          // fromFilters.setDate
        }
        else if(fromType === 2) {
          document.getElementById('frompicker').style.display = 'none';
          document.getElementById('fromInput').style.display = 'none';
          let tempDate = new Date(currentDate);
          tempDate.setDate(currentDate.getDate() - 1);
          console.log(tempDate)
          fromFilters = parseFloat(getYearWeek(tempDate))
          console.log(fromFilters)
        }
        else if(fromType === 3) {
          document.getElementById('frompicker').style.display = 'none';
          document.getElementById('fromInput').style.display = 'none';
          let tempDate = new Date(currentDate);
          fromFilters = parseFloat(getYearWeek(tempDate))
        }
        else if(fromType === 4) {
          document.getElementById('frompicker').style.display = 'none';
          document.getElementById('fromInput').style.display = 'none';
          let tempDate = new Date(currentDate);
          tempDate.setDate(currentDate.getDate() + 1);
          fromFilters = parseFloat(getYearWeek(tempDate))
        }
        else if(fromType === 5) {
          document.getElementById('fromInput').style.display = 'block';
          document.getElementById('frompicker').style.display = 'none';
          document.getElementById('fromInput').value = '1';
          fromInputVal = 1;
          let tempDate = new Date(currentDate);
          tempDate.setDate(currentDate.getDate() + 1);
          fromFilters = parseFloat(getYearWeek(tempDate))
        }
        google.charts.setOnLoadCallback(drawChart);
      }

      function toChange() {
        toType = Number(toSelect.getSelected()[0]);
        if(toType === 0){
          document.getElementById('topicker').style.display = 'block';
          document.getElementById('toInput').style.display = 'none';
          $('#topicker').datepicker('setDate', oneYearLater)
          let tempDate = new Date(oneYearLater);
          toFilters = parseFloat(getYearWeek(tempDate))
        }
        else if(toType === 1) {
          document.getElementById('toInput').style.display = 'block';
          document.getElementById('topicker').style.display = 'none';
          document.getElementById('toInput').value = '1';
          toInputVal = 1;
          let tempDate = new Date(currentDate);
          tempDate.setDate(currentDate.getDate() - 1);
          toFilters = parseFloat(getYearWeek(tempDate))
          // fromFilters.setDate
        }
        else if(toType === 2) {
          document.getElementById('topicker').style.display = 'none';
          document.getElementById('toInput').style.display = 'none';
          let tempDate = new Date(currentDate);
          tempDate.setDate(currentDate.getDate() - 1);
          toFilters = parseFloat(getYearWeek(tempDate))
        }
        else if(toType === 3) {
          document.getElementById('topicker').style.display = 'none';
          document.getElementById('toInput').style.display = 'none';
          let tempDate = new Date(currentDate);
          toFilters = parseFloat(getYearWeek(tempDate))
        }
        else if(toType === 4) {
          document.getElementById('topicker').style.display = 'none';
          document.getElementById('toInput').style.display = 'none';
          let tempDate = new Date(currentDate);
          tempDate.setDate(currentDate.getDate() + 1);
          toFilters = parseFloat(getYearWeek(tempDate))
        }
        else if(toType === 5) {
          document.getElementById('toInput').style.display = 'block';
          document.getElementById('topicker').style.display = 'none';
          document.getElementById('toInput').value = '1';
          toInputVal = 1;
          let tempDate = new Date(currentDate);
          tempDate.setDate(currentDate.getDate() + 1);
          toFilters = parseFloat(getYearWeek(tempDate))
        }
        google.charts.setOnLoadCallback(drawChart);
      }

      document.addEventListener('DOMContentLoaded', () => {
        const employeeInput = document.getElementById('employeeInput');
        const fromInput = document.getElementById('fromInput');
        const toInput = document.getElementById('toInput');
        
        $('#frompicker').datepicker('setDate', currentDate)
        $('#topicker').datepicker('setDate', oneYearLater);
        const sameAxis = document.getElementById('sameaxis');

        loadingElement = document.getElementById('loading');
        resultElement = document.getElementById('chart_div');

        // Show loading indicator
        loadingElement.style.display = 'flex';

        let timeout = null;

        fromInput.addEventListener('input', () => {
          fromInputVal = Number(fromInput.value);
          let tempDate = new Date(currentDate);
          if(fromType === 1){
            tempDate.setDate(currentDate.getDate() - fromInputVal);
            fromFilters = parseFloat(getYearWeek(tempDate))
          }
          else if(fromType === 5) {
            tempDate.setDate(currentDate.getDate() + fromInputVal);
            fromFilters = parseFloat(getYearWeek(tempDate))
          }
          google.charts.setOnLoadCallback(drawChart);
        })

        toInput.addEventListener('input', () => {
          toInputVal = Number(toInput.value);
          let tempDate = new Date(currentDate);
          if(toType === 1){
            tempDate.setDate(currentDate.getDate() - toInputVal);
            toFilters = parseFloat(getYearWeek(tempDate))
          }
          else if(toType === 5) {
            tempDate.setDate(currentDate.getDate() + toInputVal);
            toFilters = parseFloat(getYearWeek(tempDate))
          }
          google.charts.setOnLoadCallback(drawChart);
        })

        sameAxis.addEventListener('change', () => {
          if(sameAxis.checked) {
            same = true;
          } else {
            same = false;
          }
          google.charts.setOnLoadCallback(drawChart);
        })
        employeeInput.addEventListener('input', () => {
          // Clear the previous timeout
          clearTimeout(timeout);

          // Set a new timeout
          timeout = setTimeout(() => {
            performSearch(employeeInput.value);
          }, 800); 
        });
        // autocomplete('#employeeInput', { hint: false }, [
        //   {
        //     source: function(query, callback) {
        //       // Filter the data based on the query
        //       const matches = employeeFilter.filter(employee => {
        //         return employee.name.toLowerCase().startsWith(query.toLowerCase());
        //       });
        //       callback(matches);
        //     },
        //     displayKey: 'name',
        //     templates: {
        //       suggestion: function(suggestion) {
        //         return '<div>' + suggestion.name + '</div>';
        //       }
        //     }
        //   }
        // ]);
      });
      function performSearch(query) {
        emploSelFilter = query;
        google.charts.setOnLoadCallback(drawChart);
        // console.log('Searching for:', query);
      }
      function isValidYearWeek(yearWeek) {
        const regex = /^\d{4}\.\d{2}$/;
        return regex.test(yearWeek);
      }
      async function getFilters(){
        try {
          const sumMap = {};

          // let dataa = 0;
          const tempEmployee = [];
          calendar_resource_Data.forEach(([yearWeek, resourceFTE, calendarFTE, serviceType, assayType, laboratory, department, employee, netherlands, calendarType, lenexa, whitesboro]) => {
            if (yearWeek >= from && yearWeek <= to) {
              if( !serviceTypes.includes(serviceType) && serviceType !== "") {
                serviceTypes.push(serviceType)
              }
              if( !assayTypes.includes(assayType) && assayType !== "") {
                assayTypes.push(assayType)
              }
              if( !laboratoryFilters.includes(laboratory.toUpperCase()) && laboratory !== "" ){
                laboratoryFilters.push(laboratory.toUpperCase())
              }
              if( !departmentFilters.includes(department.toUpperCase()) && department !== "" ){
                departmentFilters.push(department.toUpperCase())
              }
              if(!employeeFilter.includes(employee) && employee !== ""){
                employeeFilter.push(employee);
              }
              if( !netherlands_E_Filters.includes(netherlands) && netherlands !== "" ){
                netherlands_E_Filters.push(netherlands)
              }
              if( !lenexa_E_Filters.includes(lenexa) && lenexa !== "" ){
                lenexa_E_Filters.push(lenexa)
              }
              if( !whitesboro_E_Filters.includes(whitesboro) && whitesboro !== "" ){
                whitesboro_E_Filters.push(whitesboro)
              }
              if( !calendarTypeFilters.includes(calendarType) && calendarType !== "" ){
                calendarTypeFilters.push(calendarType)
              }
            }
          });
          // serviceTypes.push('None');
          // assayTypes.push('None');
          // employeeFilter = tempEmployee.map(item => {
          //   return {name: item}
          // })
          laboratorySelect.setData(laboratoryFilters.map(item => {
            return {text: item, value: item}
          }))
          departmentSelect.setData(departmentFilters.map(item => {
            return {text: item, value: item}
          }))
          employeeSelect.setData(employeeFilter.map(item => {
            return {text: item, value: item}
          }))
          calendarSelect.setData(calendarTypeFilters.map(item => {
            return {text: item, value: item}
          }))
        } catch (error) {
          console.error('Error fetching data from Quickbase:', error);
          throw error;
        }
      }
      async function getFilterData(){
        const headers = {
          'QB-Realm-Hostname': 'icon.quickbase.com',
          'Authorization': 'QB-USER-TOKEN b9mjdd_py5p_0_bq3jzc2ceck37fb65tg4ybwegaxm',
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(`https://api.quickbase.com/v1/records/query`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              "from": 'bub7gjqmz',
              "select": [6,7,8,9,10,11,12,13,14,15,16,17,18],
              "options": {
                "skip": 0,
                "top": 0,
                "compareWithAppLocalTime": false
              }
            })
          });

          if (!response.ok) {
            throw new Error(`Failed to fetch data from Quickbase: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();

          if (!data.data) {
            throw new Error('Data not found in API response');
          }
          sidebarData = data.data.map(item => {
            return {
              id: webix.uid(), 
              value: item[`13`].value, 
              filter: {
                laboratory: JSON.parse(item['6'].value),
                department: JSON.parse(item['7'].value),
                employees: JSON.parse(item['8'].value),
                calendarType: JSON.parse(item['9'].value),
                employee: item['10'].value,
                from: parseFloat(item['11'].value),
                to: parseFloat(item['12'].value),
                stacked: Number(item['14'].value),
                fromType: Number(item['15'].value),
                fromInputVal: Number(item['16'].value),
                toType: Number(item['17'].value),
                toInputVal: Number(item['18'].value),
              }
            }
          })
          $$("mySidebar").clearAll();
          $$("mySidebar").parse(sidebarData);
        } catch (error) {
          console.error('Error fetching data from Quickbase:', error);
          throw error;
        }
      }
      async function fetchDataFromQuickbase(tableId, appId, serviceType_ID, assayType_ID, id1, id2, id3, laboratory, department, employee, netherlands, calendarType, lenexa, whitesboro) {
        const headers = {
          'QB-Realm-Hostname': 'icon.quickbase.com',
          'Authorization': 'QB-USER-TOKEN b9mjdd_py5p_0_bq3jzc2ceck37fb65tg4ybwegaxm',
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(`https://api.quickbase.com/v1/records/query`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              "from": tableId,
              "select": [id1, id2, id3, serviceType_ID, assayType_ID, laboratory, department, employee, netherlands, calendarType, lenexa, whitesboro],
              "options": {
                "skip": 0,
                "top": 0,
                "compareWithAppLocalTime": false
              }
            })
          });

          if (!response.ok) {
            throw new Error(`Failed to fetch data from Quickbase: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();

          if (!data.data) {
            throw new Error('Data not found in API response');
          }
          const transformedData = data.data.map(record => {
            return [
              record[`${id1}`]?.value ?? 0, 
              record[`${id2}`]?.value ?? 0,
              record[`${id3}`]?.value ?? 0,
              record[`${serviceType_ID}`]?.value ?? 'None',
              record[`${assayType_ID}`]?.value ?? 'None',
              record[`${laboratory}`]?.value ?? 0, 
              record[`${department}`]?.value ?? 0,
              record[`${employee}`]?.value ?? 0,
              record[`${netherlands}`]?.value ?? 0,
              record[`${calendarType}`]?.value ?? 0,
              record[`${lenexa}`]?.value ?? 0,
              record[`${whitesboro}`]?.value ?? 0,
            ];
          });

          return transformedData;

        } catch (error) {
          console.error('Error fetching data from Quickbase:', error);
          throw error;
        }
      }

      function includeName(datalist, name) {
        for (let i = 0; i < datalist.length; i++) {
          if (name.includes(datalist[i])) {
            return true;
          }
        }
        return false;
      }

      function employeeValid(netherlands, lenexa, whitesboro, employee) {
        if(laboSelFilter[0] === 'NETHERLANDS') {
          if(employeeSelFilter.includes(netherlands)) return true
          else return false
        }
        else if(laboSelFilter[0] === 'LENEXA') {
          if(employeeSelFilter.includes(lenexa)) return true
          else return false
        }
        else if(laboSelFilter[0] === 'WHITESBORO') {
          if(employeeSelFilter.includes(whitesboro)) return true
          else return false
        } else {
          if(employeeSelFilter.includes(employee)) return true
          else return false
        }
      }

      function recorrect(data) {
        const sumMap = {};
        if(fromFilters !== 0 && toFilters !== 0 && fromFilters > toFilters) {
          document.getElementById('chart_div').innerHTML = "Please enter valid dates.";
          return;
        }
        // let dataa = 0;
        let employList = [];
        if(emploSelFilter !== '') employList= emploSelFilter.split(" OR ").map(part => part.toUpperCase().trim()).filter(part => part);;
        const length = stackedType === 1 ? serviceTypes.length : stackedType === 2 ? assayTypes.length : 0;
        data.forEach(([yearWeek, resourceFTE, calendarFTE, serviceType, assayType, laboratory, department, employee, netherlands, calendarType, lenexa, whitesboro]) => {
          if (yearWeek >= from && (yearWeek >= fromFilters || fromFilters === 0) && 
              yearWeek <= to && (yearWeek <= toFilters || toFilters === 0) &&
              (laboSelFilter.length === 0 || laboSelFilter.includes(laboratory.toUpperCase())) && 
              (deparSelFilter.length === 0 || deparSelFilter.includes(department.toUpperCase())) && 
              (employList.length === 0 || includeName(employList, employee.toUpperCase().trim())) && 
              (employeeSelFilter.length === 0 || employeeValid(netherlands, lenexa, whitesboro, employee)) &&
              (calendarSelFilter.length === 0 || calendarSelFilter.includes(calendarType))) {
            // serviceType = serviceType !== "" ? serviceType : 'None';
            // assayType = assayType !== "" ? assayType : 'None';
            if(stackedType !== 0){
              if (!sumMap[yearWeek]) {
                const temp = stackedType === 1 ? serviceTypes.map(item => 0) : assayTypes.map(item => 0);
                temp.push([0, 0]);
                sumMap[yearWeek] = temp.flat();
              }
              // console.log("serviceType: ", serviceType, "assayType: ", assayType)
              sumMap[yearWeek][0] += Number(resourceFTE);
              let flag = 0;
              if(stackedType === 2){
                assayTypes.forEach((item, index) => {
                  if(item === assayType) {
                    flag = 1;
                    sumMap[yearWeek][index + 1] += Number(calendarFTE);
                  }
                });
              } else {
                serviceTypes.forEach((item, index) => {
                  if(item === serviceType) {
                    flag = 1;
                    sumMap[yearWeek][index + 1] += Number(calendarFTE);
                  }
                });
              }
              if(flag === 0)
                sumMap[yearWeek][length + 1] += Number(calendarFTE);
            } else {
              if (!sumMap[yearWeek]) {
                sumMap[yearWeek] = [0, 0];
              }
              sumMap[yearWeek][0] += resourceFTE;
              sumMap[yearWeek][1] += calendarFTE;
            }
          }
        });
        const summedData = Object.entries(sumMap).map(([yearWeek, FTEList]) => {
          const FTE = FTEList.map(item => {return Number(item.toFixed(2))});
          // console.log(FTE)
          
          return [yearWeek, FTE].flat();
          // return [parseFloat(yearWeek), Number(resourceFTE.toFixed(2)), Number(calendarFTE.toFixed(2))];
        });
        summedData.sort((a, b) => a[0] - b[0]);
        const result = summedData.map(item => {
          const year = Math.floor(item[0]);
          const week = Math.floor(item[0] * 100 - year * 100);
          const formattedYearWeek = `${year}.${week}`;
          item[0] = formattedYearWeek;
          return item
        })
        return result;
      };

      async function getData() {
        const calendarResourceEventsTableId = 'bttrpwc8h';
        const Year_week_ID = 88;
        const ResourceFTE_ID = 69;
        const CalendarFTE_ID = 70;
        const serviceType_ID = 80;
        const assayType_ID = 102;
        const laboratory = 67;
        const department = 68;
        const employee = 79;
        const netherlands = 98;
        const calendarType = 92;
        const lenexa = 99;
        const whitesboro = 100;
        const appId = 'br37izpar';

        try {
          calendar_resource_Data = await fetchDataFromQuickbase(calendarResourceEventsTableId, 
                                                                appId, 
                                                                serviceType_ID,
                                                                assayType_ID,
                                                                Year_week_ID, 
                                                                ResourceFTE_ID, 
                                                                CalendarFTE_ID,
                                                                laboratory,
                                                                department,
                                                                employee,
                                                                netherlands,
                                                                calendarType,
                                                                lenexa,
                                                                whitesboro);
          return calendar_resource_Data;
        } catch (error) {
          console.error(error)
        }
      }

      async function drawChart() {
        if(!calendar_resource_Data) return
        try{
          const resultData = recorrect(calendar_resource_Data);
          if (!resultData || resultData.length <= 0) {
            document.getElementById('chart_div').innerHTML = "No matching records found for your search.";
            return;
          }
          let stackedAxis = [];
          if(stackedType === 1) {
            stackedAxis = serviceTypes.map(item => {
              return `Calendar Event FTE - ${item}`
            })
          } else {
            stackedAxis = assayTypes.map(item => {
              return `Calendar Event FTE - ${item}`
            })
          }
          const axis = ['Year-Week', 'Resource FTE', stackedAxis, 'Calendar Event FTE - None'].flat();
          let chartData = [];
          if(stackedType === 0){
            chartData = [
              ['Year-Week', 'Resource FTE', 'Calendar Event FTE'],
              ...resultData.map(([yearWeek, resourceFTE, calendarFTE]) => {
                return [yearWeek, resourceFTE, calendarFTE];
              })
            ];
          }
          else {
            chartData = [
              axis,
              ...resultData
            ]
          }
          const data = google.visualization.arrayToDataTable(chartData);
          // const viewData = new google.visualization.DataView(data);

          const chart = new google.visualization.ComboChart(document.getElementById('chart_div'));
          let option;
          var seriesOptions = {};
          for (var i = 1; i < stackedAxis.length + 2; i++) {
            if(same)
              seriesOptions[i] = { type: 'bars' };
            else 
              seriesOptions[i] = { type: 'bars', targetAxisIndex: 1 };
          }
          seriesOptions[0] = { type: 'line' };
          option = {
            title: stackedType === 0 ? 'Calendar + Resource FTE' : 'Calendar + Resource FTE(Stacked Bar)',
            curveType: 'none',
            seriesType: 'line',
            series: stackedType === 0 ? {
              0: { color: 'blue', curveType: 'none' },
              1: { color: 'red', type: 'bars' }
            } : seriesOptions,
            legend: { position: 'bottom' },
            hAxis: {
              title: 'Year-Week'
            },
            pointSize: 4,
            annotations: {
              textStyle: {
                fontSize: 12, 
                bold: true
              },
              highContrast: true
            },
            vAxis: {
              title: 'FTE',
            },
            isStacked: true,
          }
          chart.draw(data, option);


        } catch (error) {
          console.error('Error drawing the chart:', error);
        }
      }

      function populateSelect(selectId, options) {
        const selectElement = document.getElementById(selectId);
        options.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option;
          optionElement.textContent = option;
          selectElement.appendChild(optionElement);
        });
      }
      
      google.charts.load('current', {
        'packages': ['corechart']
      });
      getFilterData();
      getData().then((val) => {
        getFilters();
        loadingElement.style.display = 'none';

            // Show result
        resultElement.style.display = 'flex';
        google.charts.setOnLoadCallback(drawChart);
      });

      // Move the sidebar to the right side
      document.querySelector('.webix_sidebar').style.position = 'fixed';
      document.querySelector('.webix_sidebar').style.right = '0';
      document.querySelector('.webix_sidebar').style.top = '0';
      document.querySelector('.webix_sidebar').style.height = '100%';
    </script>
  </body>
</html>
