<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://unpkg.com/slim-select@latest/dist/slimselect.min.js"></script>
    <link href="https://unpkg.com/slim-select@latest/dist/slimselect.css" rel="stylesheet"></link>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.webix.com/edge/webix.min.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.min.css">
    <style>
        /* Custom styles for the autocomplete suggestions */
        .aa-suggestions {
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .aa-suggestion {
            padding: 10px;
            cursor: pointer;
        }
        .aa-dropdown-menu {
          margin-left: 20px;
        }
        .aa-suggestion:hover,
        .aa-suggestion.aa-cursor {
            background-color: #f0f0f0;
        }
        
        .aa-suggestion div {
            font-size: 14px;
        }
        .webix_layout_line .webix_sidebar {
            right: 0;
            left: auto;
            overflow-y: auto;
        }
        #sidebar {
          position: absolute;
          right: 0;
        }
        .delete-icon {
            cursor: pointer;
            margin-left: 10px;
            color: rgb(117, 110, 110);
        }
        .webix_tree_item {
          display: flex;
          justify-content: space-between;
        }
    </style>
    <style>
      .google-visualization-controls-label{
        padding-bottom: 8px;
      }
    </style>
  </head>
  <body class="flex flex-row ">
    <div id="combo_chart_div" style="width: 80vw;">
      <div class="flex flex-col">
        <div class="flex flex-row items-center">
          <select id="laboratory" multiple class="w-[300px] m-4" >
          </select>
          <select id="department" multiple class="w-[300px] m-4">
          </select>
          <select id="netherlands" multiple class="w-[300px] m-4">
          </select>
          <select id="calendartype" multiple class="w-[300px] m-4">
          </select>
        </div>
        <div class="flex flex-row items-center">
          <input type="text" id="employeeInput" placeholder="Employee" class="w-[150px], border h-[30px] rounded m-4">
          <div class="ml-2">From:</div>
          <input type="text" id="fromInput" placeholder="From Year-Week(****.**)" class="w-[150px], border h-[30px] rounded m-4">
          <div class="ml-2">To:</div>
          <input type="text" id="toInput" placeholder="To Year-Week(****.**)" class="w-[150px], border h-[30px] rounded m-4">
        </div>
        <div class="flex flex-row items-center">
          <input type="text" id="name" class="w-[150px], border h-[30px] rounded m-4" placeholder="Enter the name for saving.">
          <button onclick="saveFilters()">Save</button>
        </div>
      </div>
      <div id="chart_div" style="width: 90vw; height: 80vh;" class="flex items-center justify-center"></div>
    </div>
    <div id="sidebar"></div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.webix.com/edge/webix.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.min.js"></script>
    <script type="text/javascript">
      let sidebarData = [];

        // Initialize Webix layout with sidebar on the right
      webix.ui({
        container: "sidebar",
        rows: [
          {
            cols: [
              {
                view: "sidebar",
                id: "mySidebar",
                data: sidebarData,
                gravity: 1,
                template: function(obj) {
                  return obj.value + `<span class='delete-icon' data-id='${obj.id}'>&#10060;</span>`;
                },
                onClick: {
                  "delete-icon": function(e, id) {        
                    const item = this.getItem(id);
                    deleteItemFromSidebar(id, item.value);
                    return false; // Prevents the default item click event
                  }
                },
                on: {
                  onItemClick: function(id) {
                    // Get the clicked item data
                    const item = this.getItem(id);
                    setFilter(item.filter)
                  }
                }
              }
            ]
          }
        ]
      });


      // Function to delete an item from the sidebar
      function deleteItemFromSidebar(id, name) {
        var headers = {
            'QB-Realm-Hostname': 'icon.quickbase.com',
            'Authorization': `QB-USER-TOKEN b9mjdd_py5p_0_bq3jzc2ceck37fb65tg4ybwegaxm`,
            'Content-Type': 'application/json'
        }
        var body = {
          from: 'bub7gjqmz',
          where: `{13.EX.${name}}`
        }

        fetch('https://api.quickbase.com/v1/records',
          {
            method: 'DELETE',
            headers: headers,
            body: JSON.stringify(body)
          })
        .then(res => {
          if (res.ok) {
            return res.json().then(res => console.log(res));
          }
          return res.json().then(resBody => Promise.reject({status: res.status, ...resBody}));
        })
        .catch(err => console.log(err))
        sidebarData = sidebarData.filter(item => item.id != id);
        $$("mySidebar").clearAll();
        $$("mySidebar").parse(sidebarData);
      }

      let calendar_resource_Data, displayData, laboratoryFilters = [], employeeFilter = [], departmentFilters = [];
      let netherlands_E_Filters = [], calendarTypeFilters = [];
      let laboSelFilter = [], deparSelFilter = [], emploSelFilter = "", netheSelE_Filter = [], calendarSelFilter = [], fromFilters = 0, toFilters = 0 ;
      let from = parseFloat(getYearWeek(new Date()));
      let to = parseFloat(getYearWeek(new Date(), 1));
      let laboratorySelect = new SlimSelect({
        select: '#laboratory',
        settings: {
          placeholderText: 'Laboratory',
        },
        events: {
          afterChange: (newVal) => {
            laboratoryChange();
          }
        }
      })
      let departmentSelect = new SlimSelect({
        select: '#department',
        settings: {
          placeholderText: 'Department',
        },
        events: {
          afterChange: (newVal) => {
            departmentChange();
          }
        }
      })
      let netherlandsSelect = new SlimSelect({
        select: '#netherlands',
        settings: {
          placeholderText: 'Netherlands Employee',
        },
        events: {
          afterChange: (newVal) => {
            netherlandsChange();
          }
        }
      })
      let calendarSelect = new SlimSelect({
        select: '#calendartype',
        settings: {
          placeholderText: 'Calendar Type',
        },
        events: {
          afterChange: (newVal) => {
            calendarChange();
          }
        }
      })

      async function saveFilters() {

        const url = `https://api.quickbase.com/v1/records`;
        const name = document.getElementById('name').value;
        if(!name) {
          Swal.fire({
            text: 'Please enter the name for saving.',
            icon: 'warning', // 'success', 'error', 'warning', 'info', or 'question'
            timer: 4000, // Auto close in 4 seconds
            showConfirmButton: false, // Hide the "OK" button
            timerProgressBar: true, // Show timer progress bar
            toast: true, // Make it a toast notification
            position: 'top-end', // Position of the notification
            showCloseButton: true // Show close button
          });
          return
        }
        const payload = {
          to: 'bub7gjqmz',
          data: [
            {
              13: {
                "value": name
              },
              6: {
                "value": JSON.stringify(laboSelFilter)
              },
              7: {
                "value": JSON.stringify(deparSelFilter)
              },
              8: {
                "value": JSON.stringify(netheSelE_Filter)
              },
              9: {
                "value": JSON.stringify(calendarSelFilter)
              },
              10: {
                "value": emploSelFilter
              },
              11: {
                "value": String(fromFilters)
              },
              12: {
                "value": String(toFilters)
              },
            }
          ]
        };
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'QB-Realm-Hostname': 'icon.quickbase.com',
            'Authorization': `QB-USER-TOKEN b9mjdd_py5p_0_bq3jzc2ceck37fb65tg4ybwegaxm`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const newItem = { id: webix.uid(), value: name, filter: {
            laboratory: laboSelFilter,
            department: deparSelFilter,
            netherlands: netheSelE_Filter,
            calendarType: calendarSelFilter,
            employee: emploSelFilter,
            from: fromFilters,
            to: toFilters,
          } 
        };
        sidebarData.push(newItem);
        $$("mySidebar").clearAll();
        $$("mySidebar").parse(sidebarData);
        const result = await response.json();

        Swal.fire({
          text: 'Save successful.',
          icon: 'success', // 'success', 'error', 'warning', 'info', or 'question'
          timer: 4000, // Auto close in 4 seconds
          showConfirmButton: false, // Hide the "OK" button
          timerProgressBar: true, // Show timer progress bar
          toast: true, // Make it a toast notification
          position: 'top-end', // Position of the notification
          showCloseButton: true // Show close button
        });
      }
      function setFilter (filter) {
        laboSelFilter = filter?.laboratory;
        laboratorySelect.setSelected(laboSelFilter);
        deparSelFilter = filter?.department;
        departmentSelect.setSelected(deparSelFilter);
        netheSelE_Filter = filter?.netherlands;
        netherlandsSelect.setSelected(netheSelE_Filter);
        calendarSelFilter = filter?.calendarType;
        calendarSelect.setSelected(calendarSelFilter);
        emploSelFilter = filter?.employee;
        document.getElementById('employeeInput').value = emploSelFilter;
        fromFilters = filter?.from;
        document.getElementById('fromInput').value = fromFilters;
        toFilters = filter?.to;
        document.getElementById('toInput').value = toFilters;
        google.charts.setOnLoadCallback(drawChart);
      }
      function getYearWeek(date, flag) {
        const target = new Date(date.valueOf());
        const dayNumber = (date.getUTCDay() + 6) % 7; // Get the day number (0-6), with Monday being 0
        target.setUTCDate(target.getUTCDate() - dayNumber + 3); // Set the target date to the Thursday of the current week
        const firstThursday = new Date(target.getUTCFullYear(), 0, 4); // Get the first Thursday of the year
        const diff = target - firstThursday;
        const oneWeek = 1000 * 60 * 60 * 24 * 7;
        const weekNumber = 1 + Math.round(diff / oneWeek); // Calculate the week number

        // Get the year corresponding to the week
        const firstDayOfWeek = new Date(target.setUTCDate(target.getUTCDate() - target.getUTCDay() + 1));
        const year = firstDayOfWeek.getUTCFullYear();
        
        // Format the week number as a two-digit string
        const formattedWeekNumber = weekNumber.toString().padStart(2, '0');
        if(flag === 1) return `${year + 1}.${formattedWeekNumber}`;
        return `${year}.${formattedWeekNumber}`;
      }

      function laboratoryChange() {
        laboSelFilter = laboratorySelect.getSelected();
        google.charts.setOnLoadCallback(drawChart);
      }
      function departmentChange() {
        deparSelFilter = departmentSelect.getSelected();
        google.charts.setOnLoadCallback(drawChart);
      }
      function netherlandsChange() {
        netheSelE_Filter = netherlandsSelect.getSelected();
        google.charts.setOnLoadCallback(drawChart);
      }
      function calendarChange() {
        calendarSelFilter = calendarSelect.getSelected();
        google.charts.setOnLoadCallback(drawChart);
      }
      document.addEventListener('DOMContentLoaded', () => {
        const employeeInput = document.getElementById('employeeInput');
        const fromInput = document.getElementById('fromInput');
        const toInput = document.getElementById('toInput');
        let timeout = null;

        employeeInput.addEventListener('input', () => {
          // Clear the previous timeout
          clearTimeout(timeout);

          // Set a new timeout
          timeout = setTimeout(() => {
            performSearch(employeeInput.value);
          }, 800); 
        });
        fromInput.addEventListener('input', () => {
          // Clear the previous timeout
          const flag = isValidYearWeek(fromInput.value);
          if(flag === true) fromFilters = parseFloat(fromInput.value);
          else fromFilters = 0;
          google.charts.setOnLoadCallback(drawChart);
          
        });
        toInput.addEventListener('input', () => {
          const flag = isValidYearWeek(toInput.value);
          if(flag === true) toFilters = parseFloat(toInput.value);
          else toFilters = 0;
          google.charts.setOnLoadCallback(drawChart);
        });
        autocomplete('#employeeInput', { hint: false }, [
          {
            source: function(query, callback) {
              // Filter the data based on the query
              const matches = employeeFilter.filter(employee => {
                return employee.name.toLowerCase().startsWith(query.toLowerCase());
              });
              callback(matches);
            },
            displayKey: 'name',
            templates: {
              suggestion: function(suggestion) {
                return '<div>' + suggestion.name + '</div>';
              }
            }
          }
        ]);
      });
      function performSearch(query) {
        emploSelFilter = query;
        google.charts.setOnLoadCallback(drawChart);
        // console.log('Searching for:', query);
      }
      function isValidYearWeek(yearWeek) {
        const regex = /^\d{4}\.\d{2}$/;
        return regex.test(yearWeek);
      }
      async function getFilters(){
        try {
          const sumMap = {};

          // let dataa = 0;
          const tempEmployee = [];
          calendar_resource_Data.forEach(([yearWeek, resourceFTE, calendarFTE, laboratory, department, employee, netherlands, calendarType]) => {
            if (yearWeek >= from && yearWeek <= to) {
              if( !laboratoryFilters.includes(laboratory.toUpperCase()) && laboratory !== "" ){
                laboratoryFilters.push(laboratory.toUpperCase())
              }
              if( !departmentFilters.includes(department.toUpperCase()) && department !== "" ){
                departmentFilters.push(department.toUpperCase())
              }
              if(!tempEmployee.includes(employee) && employee !== ""){
                tempEmployee.push(employee);
              }
              if( !netherlands_E_Filters.includes(netherlands) && netherlands !== "" ){
                netherlands_E_Filters.push(netherlands)
              }
              if( !calendarTypeFilters.includes(calendarType) && calendarType !== "" ){
                calendarTypeFilters.push(calendarType)
              }
            }
          });
          employeeFilter = tempEmployee.map(item => {
            return {name: item}
          })
          laboratorySelect.setData(laboratoryFilters.map(item => {
            return {text: item, value: item}
          }))
          departmentSelect.setData(departmentFilters.map(item => {
            return {text: item, value: item}
          }))
          netherlandsSelect.setData(netherlands_E_Filters.map(item => {
            return {text: item, value: item}
          }))
          calendarSelect.setData(calendarTypeFilters.map(item => {
            return {text: item, value: item}
          }))
        } catch (error) {
          console.error('Error fetching data from Quickbase:', error);
          throw error;
        }
      }
      async function getFilterData(){
        const headers = {
          'QB-Realm-Hostname': 'icon.quickbase.com',
          'Authorization': 'QB-USER-TOKEN b9mjdd_py5p_0_bq3jzc2ceck37fb65tg4ybwegaxm',
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(`https://api.quickbase.com/v1/records/query`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              "from": 'bub7gjqmz',
              "select": [6,7,8,9,10,11,12,13],
              "options": {
                "skip": 0,
                "top": 0,
                "compareWithAppLocalTime": false
              }
            })
          });

          if (!response.ok) {
            throw new Error(`Failed to fetch data from Quickbase: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();

          if (!data.data) {
            throw new Error('Data not found in API response');
          }
          sidebarData = data.data.map(item => {
            console.log(item['6'])
            return {
              id: webix.uid(), 
              value: item[`13`].value, 
              filter: {
                laboratory: JSON.parse(item['6'].value),
                department: JSON.parse(item['7'].value),
                netherlands: JSON.parse(item['8'].value),
                calendarType: JSON.parse(item['9'].value),
                employee: item['10'].value,
                from: parseFloat(item['11'].value),
                to: parseFloat(item['12'].value),
              }
            }
          })
          $$("mySidebar").clearAll();
          $$("mySidebar").parse(sidebarData);
        } catch (error) {
          console.error('Error fetching data from Quickbase:', error);
          throw error;
        }
      }
      async function fetchDataFromQuickbase(tableId, appId, id1, id2, id3, laboratory, department, employee, netherlands, calendarType) {
        const headers = {
          'QB-Realm-Hostname': 'icon.quickbase.com',
          'Authorization': 'QB-USER-TOKEN b9mjdd_py5p_0_bq3jzc2ceck37fb65tg4ybwegaxm',
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(`https://api.quickbase.com/v1/records/query`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              "from": tableId,
              "select": [id1, id2, id3, laboratory, department, employee, netherlands, calendarType],
              "options": {
                "skip": 0,
                "top": 0,
                "compareWithAppLocalTime": false
              }
            })
          });

          if (!response.ok) {
            throw new Error(`Failed to fetch data from Quickbase: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();

          if (!data.data) {
            throw new Error('Data not found in API response');
          }
          const transformedData = data.data.map(record => {
            return [
              record[`${id1}`]?.value ?? 0, 
              record[`${id2}`]?.value ?? 0,
              record[`${id3}`]?.value ?? 0,
              record[`${laboratory}`]?.value ?? 0, 
              record[`${department}`]?.value ?? 0,
              record[`${employee}`]?.value ?? 0,
              record[`${netherlands}`]?.value ?? 0,
              record[`${calendarType}`]?.value ?? 0,
            ];
          });

          return transformedData;

        } catch (error) {
          console.error('Error fetching data from Quickbase:', error);
          throw error;
        }
      }

      function recorrect(data) {
        const sumMap = {};
        if(fromFilters !== 0 && toFilters !== 0 && fromFilters > toFilters) {
          document.getElementById('chart_div').innerHTML = "Please enter valid dates.";
          return;
        }
        // let dataa = 0;
        data.forEach(([yearWeek, resourceFTE, calendarFTE, laboratory, department, employee, netherlands, calendarType]) => {
          if (yearWeek >= from && (yearWeek >= fromFilters || fromFilters === 0) && 
              yearWeek <= to && (yearWeek <= toFilters || toFilters === 0) &&
              (laboSelFilter.length === 0 || laboSelFilter.includes(laboratory.toUpperCase())) && 
              (deparSelFilter.length === 0 || deparSelFilter.includes(department.toUpperCase())) && 
              (emploSelFilter === "" || employee.toUpperCase().includes(emploSelFilter.toUpperCase())) && 
              (netheSelE_Filter.length === 0 || netheSelE_Filter.includes(netherlands)) &&
              (calendarSelFilter.length === 0 || calendarSelFilter.includes(calendarType))) {
            if (!sumMap[yearWeek]) {
              sumMap[yearWeek] = [0, 0];
            }
            sumMap[yearWeek][0] += resourceFTE;
            sumMap[yearWeek][1] += calendarFTE;
          }
        });
        const summedData = Object.entries(sumMap).map(([yearWeek, [resourceFTE, calendarFTE]]) => {
          return [parseFloat(yearWeek), Number(resourceFTE.toFixed(2)), Number(calendarFTE.toFixed(2))];
        });
        summedData.sort((a, b) => a[0] - b[0]);
        return summedData;
      };

      async function getData() {
        const calendarResourceEventsTableId = 'bttrpwc8h';
        const Year_week_ID = 88;
        const ResourceFTE_ID = 69;
        const CalendarFTE_ID = 70;
        const laboratory = 67;
        const department = 68;
        const employee = 79;
        const netherlands = 98;
        const calendarType = 92;
        const appId = 'br37izpar';

        try {
          calendar_resource_Data = await fetchDataFromQuickbase(calendarResourceEventsTableId, 
                                                                appId, 
                                                                Year_week_ID, 
                                                                ResourceFTE_ID, 
                                                                CalendarFTE_ID,
                                                                laboratory,
                                                                department,
                                                                employee,
                                                                netherlands,
                                                                calendarType);
          return calendar_resource_Data;
        } catch (error) {
          console.error(error)
        }
      }

      async function drawChart() {
        try{
          const resultData = recorrect(calendar_resource_Data);
          if (!resultData || resultData.length <= 0) {
            document.getElementById('chart_div').innerHTML = "No matching records found for your search.";
            return;
          }

          const chartData = [
            ['Year-Week', 'Resource FTE', 'Calendar Event FTE'],
            ...resultData.map(([yearWeek, resourceFTE, calendarFTE]) => {
              const year = Math.floor(yearWeek);
              const week = Math.floor(yearWeek * 100 - year * 100); 
              const formattedYearWeek = `${year}.${week}`;
              return [formattedYearWeek, resourceFTE, calendarFTE];
            })
          ];

          const data = google.visualization.arrayToDataTable(chartData);
          const viewData = new google.visualization.DataView(data);

          const chart = new google.visualization.ComboChart(document.getElementById('chart_div'));
          chart.draw(viewData, {
            title: 'Calendar + Resource FTE',
            curveType: 'function',
            seriesType: 'line',
            series: {
              0: { color: 'blue', curveType: 'function' },
              1: { color: 'red', type: 'bars' }
            },
            legend: { position: 'bottom' },
            hAxis: {
              title: 'Year-Week'
            },
            pointSize: 4,
            annotations: {
              textStyle: {
                fontSize: 12, 
                bold: true
              },
              highContrast: true
            },
            vAxis: {
              title: 'FTE',
            },
          });


        } catch (error) {
          console.error('Error drawing the chart:', error);
        }
      }

      function populateSelect(selectId, options) {
        const selectElement = document.getElementById(selectId);
        console.log(selectId)
        console.log(selectElement);
        options.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option;
          optionElement.textContent = option;
          selectElement.appendChild(optionElement);
        });
      }
      
      google.charts.load('current', {
        'packages': ['corechart']
      });
      getFilterData();
      getData().then((val) => {
        getFilters();
        google.charts.setOnLoadCallback(drawChart);
      });

      // Move the sidebar to the right side
      document.querySelector('.webix_sidebar').style.position = 'fixed';
      document.querySelector('.webix_sidebar').style.right = '0';
      document.querySelector('.webix_sidebar').style.top = '0';
      document.querySelector('.webix_sidebar').style.height = '100%';
    </script>
  </body>
</html>
